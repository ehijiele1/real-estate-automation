# main.py - VannieJay Weekly Content Calendar Generator

from dotenv import load_dotenv
import os
import smtplib
import ssl
from email.message import EmailMessage
from pathlib import Path
import pandas as pd
from datetime import datetime, timedelta
from random import choice, shuffle

# ----------------------------
# LOAD ENVIRONMENT VARIABLES
# ----------------------------
load_dotenv()

EMAIL_SENDER = os.getenv("EMAIL_SENDER")
EMAIL_APP_PASSWORD = os.getenv("EMAIL_APP_PASSWORD")
EMAIL_RECIPIENT = os.getenv("EMAIL_RECIPIENT")
EMAIL_NOTIFICATION = os.getenv("EMAIL_NOTIFICATION", "true").lower() == "true"
WHATSAPP_TOKEN = os.getenv("WHATSAPP_TOKEN")
WHATSAPP_PHONE = os.getenv("WHATSAPP_PHONE")
WHATSAPP_RECIPIENT = os.getenv("WHATSAPP_RECIPIENT")

if not EMAIL_SENDER or not EMAIL_APP_PASSWORD:
    raise ValueError("Email credentials missing. Check .env file.")

# ----------------------------
# EMAIL FUNCTION
# ----------------------------
def send_email_notification(recipient, subject, body, attachments=[]):
    msg = EmailMessage()
    msg["From"] = EMAIL_SENDER
    msg["To"] = recipient
    msg["Subject"] = subject
    msg.set_content(body)

    for file in attachments:
        with open(file, "rb") as f:
            msg.add_attachment(
                f.read(),
                maintype="application",
                subtype="octet-stream",
                filename=file.name
            )

    context = ssl.create_default_context()

    with smtplib.SMTP_SSL("smtp.gmail.com", 465, context=context) as server:
        server.login(EMAIL_SENDER, EMAIL_APP_PASSWORD)
        server.send_message(msg)

    print("âœ… Gmail email sent successfully")

# ----------------------------
# CONFIGURATION
# ----------------------------
PROJECT_ROOT = Path(__file__).parent.resolve()
EXCEL_PATH = PROJECT_ROOT / "data" / "Product_Information_Base.xlsx"
BASE_OUTPUT_DIR = PROJECT_ROOT / "outputs"
PLATFORMS = ["Instagram", "Facebook", "LinkedIn Personal", "LinkedIn Business", "X"]
TIME_SLOTS = ["08:00", "13:00", "19:00"]  # 24h format for scheduler
DAYS_OF_WEEK = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]

CONTENT_DISTRIBUTION = {
    "Educational": 6,
    "Promotional": 2,
    "Strategic Marketing": 2,
    "Tips": 2,
    "Engagement Question": 2,
    "Humour": 2,
    "Inspirational": 2,
    "Industry News": 2
}

BRAND_NAME = "VannieJay Business Services"
BRAND_SLOGAN = "Empowering Dreams, Building Futures"

# ----------------------------
# HELPER FUNCTIONS
# ----------------------------
def get_week_label(week_offset=0):
    future_date = datetime.now() + timedelta(weeks=week_offset)
    week_number = future_date.isocalendar()[1]
    year = future_date.year
    return f"Week_{week_number}_{year}"

def get_week_output_dir(week_label):
    week_dir = BASE_OUTPUT_DIR / week_label
    week_dir.mkdir(parents=True, exist_ok=True)
    return week_dir

def load_products():
    print("ðŸ“Š Reading products from Excel...")
    df = pd.read_excel(EXCEL_PATH, sheet_name="Products")
    products = []

    for _, row in df.iterrows():
        if pd.notna(row.get("product_name")) and pd.notna(row.get("product_desc")):
            products.append({
                "id": row.get("product_id"),
                "name": row.get("product_name"),
                "description": row.get("product_desc"),
                "type": row.get("product_type"),
                "location": row.get("location"),
                "price": row.get("price"),
                "priority": row.get("content_priority")
            })

    print(f"âœ… Loaded {len(products)} products")
    return products

def product_story_template(product, content_type):
    value_points = [
        "save time", "save money", "avoid risks", "show proven results", "gain status", "make money"
    ]
    problem_scenarios = [
        f"As a busy entrepreneur, managing {product.get('type', 'business')} challenges is tough. "
        f"{product['name']} helps you {choice(value_points)}.",

        f"Investors often struggle with {product.get('type', 'business')} risks. "
        f"{product['name']} offers a proven solution to {choice(value_points)}.",

        f"Imagine wanting to {choice(value_points)} and being overwhelmed. "
        f"With {product['name']}, you can finally achieve your goals efficiently.",

        f"Many Nigerians miss out on {product.get('type', 'business')} opportunities. "
        f"{product['name']} ensures you {choice(value_points)} while avoiding common mistakes."
    ]

    templates = {
        "Educational": f"{choice(problem_scenarios)} Learn the benefits: {product['description']}",
        "Promotional": f"Soft promotion: {product['name']} can help you {choice(value_points)}. Our team at {BRAND_NAME} guides you every step of the way!",
        "Strategic Marketing": f"Strategic insight: Using {product['name']} properly can maximize returns and growth. {choice(problem_scenarios)}",
        "Tips": f"Tip: Apply {product['name']} to {choice(value_points)} efficiently. Consistent action leads to results.",
        "Engagement Question": f"Question: How would {product['name']} help you {choice(value_points)}? Comment your thoughts!",
        "Humour": f"They say laughter is the best medicine, but {product['name']} is a close second. Achieve success and smile along the way!",
        "Inspirational": f"Inspired by {BRAND_SLOGAN}: Using {product['name']} can help you {choice(value_points)} and reach new heights.",
        "Industry News": f"Latest Nigerian real estate and business trends: {product['name']} ensures you stay ahead and {choice(value_points)}."
    }

    return templates[content_type]

def generate_hashtags():
    return [
        "#NigeriaBusiness", "#Entrepreneurship", "#SmallBusinessSupport", "#BusinessGrowth",
        "#NigeriaStartups", "#BusinessServicesNG", "#GrowYourBusiness", "#NigerianEntrepreneurs",
        "#BusinessSolutions", "#StartUpNigeria", "#ScaleYourBusiness", "#MadeInNigeria",
        "#SupportLocalBusiness", "#BusinessStrategy", "#FinancialFreedomNG", "#TaxAdvisory",
        "#RegulatoryCompliance", "#BusinessSuccess", "#EntrepreneurLife", "#AfricanBusiness"
    ]

def create_weekly_posts(products):
    content_types = []
    for k, v in CONTENT_DISTRIBUTION.items():
        content_types.extend([k]*v)
    shuffle(content_types)

    posts = []
    day_counter = 0
    for i, content_type in enumerate(content_types):
        product = choice(products)
        post_content = product_story_template(product, content_type)
        hashtags = " ".join(generate_hashtags())
        post_platforms = {}
        for platform in PLATFORMS:
            content_text = post_content
            if platform == "X" and len(content_text) > 280:
                content_text = content_text[:275] + "..."
            post_platforms[platform] = f"{content_text}\n\nCTA: DM us or visit our website!\nHashtags: {hashtags}"

        day_name = DAYS_OF_WEEK[day_counter % 7]
        time_slot = TIME_SLOTS[i % 3]
        post_datetime = datetime.now().replace(hour=int(time_slot[:2]), minute=0, second=0) + timedelta(days=day_counter%7)

        posts.append({
            "Date": post_datetime.date(),
            "Day": day_name,
            "Time": time_slot,
            "Content Type": content_type,
            "Product": product['name'],
            **post_platforms
        })

        if (i+1) % 3 == 0:
            day_counter += 1

    return posts

def save_calendar(posts, week_dir, week_label):
    txt_file = week_dir / f"{week_label}_VannieJay_Content.txt"
    html_file = week_dir / f"{week_label}_VannieJay_Content.html"
    csv_file = week_dir / f"{week_label}_VannieJay_Content.csv"

    with open(txt_file, "w", encoding="utf-8") as f:
        for post in posts:
            f.write(f"{post['Day']} - {post['Time']} - {post['Content Type']} - {post['Product']}\n")
            for platform in PLATFORMS:
                f.write(f"[{platform}]\n{post[platform]}\n\n")
            f.write("-"*80 + "\n")

    with open(html_file, "w", encoding="utf-8") as f:
        f.write("<html><head><meta charset='utf-8'><title>Weekly Content Calendar</title></head><body>")
        f.write(f"<h1>{week_label} - VannieJay Business Services Content Calendar</h1>")
        for post in posts:
            f.write(f"<h2>{post['Day']} - {post['Time']} - {post['Content Type']} - {post['Product']}</h2>")
            for platform in PLATFORMS:
                f.write(f"<h3>{platform}</h3><p>{post[platform]}</p>")
            f.write("<hr>")
        f.write("</body></html>")

    df = pd.DataFrame(posts)
    df.to_csv(csv_file, index=False, encoding="utf-8")
    print(f"Calendar saved in folder: {week_dir}")
    return [txt_file, html_file, csv_file]

# ----------------------------
# MAIN
# ----------------------------
def main():
    print("Reading products from Excel...")
    products = load_products()
    if not products:
        print("No products found in Excel. Check columns 'product_name' and 'product_desc'.")
        return

    week_label = get_week_label()
    week_dir = get_week_output_dir(week_label)

    print(f"Generating scheduler-ready weekly posts for {week_label}...")
    weekly_posts = create_weekly_posts(products)

    print("Saving weekly calendar in TXT, HTML, and CSV...")
    files_saved = save_calendar(weekly_posts, week_dir, week_label)

    if EMAIL_NOTIFICATION:
        send_email_notification(
            recipient=EMAIL_RECIPIENT,
            subject=f"VannieJay Weekly Content Calendar - {week_label}",
            body=f"The weekly content calendar has been generated successfully for {week_label}. Check attached files.",
            attachments=files_saved
        )

    print("âœ… Weekly content calendar generation completed!")

if __name__ == "__main__":
    main()
